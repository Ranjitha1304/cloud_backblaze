{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="glass-card rounded-2xl mb-6">
        <div class="px-6 py-6">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <button onclick="window.history.back()" 
                            class="w-10 h-10 bg-gray-100 rounded-xl flex items-center justify-center text-gray-600 hover:bg-gray-200 transition-all duration-200">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">{{ file.name }}</h1>
                        <div class="flex items-center space-x-3 mt-2">
                            <span class="text-sm text-gray-600">{{ file.size|filesizeformat }}</span>
                            <span class="text-sm text-gray-600">•</span>
                            <span class="text-sm text-gray-600">{{ file.file_type|upper }}</span>
                            <span class="text-sm text-gray-600">•</span>
                            <span class="text-sm text-gray-600">Uploaded {{ file.uploaded_at|date:"M d, Y" }}</span>
                        </div>
                    </div>
                </div>
                <div class="flex space-x-3">
                    <a href="{% url 'download_file' file.id %}" 
                       class="bg-blue-600 text-white px-6 py-3 rounded-xl font-semibold hover:bg-blue-700 transition-all duration-200 flex items-center space-x-2">
                        <i class="fas fa-download"></i>
                        <span>Download</span>
                    </a>
                    <a href="{% url 'file_list' %}" 
                       class="bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold hover:bg-gray-700 transition-all duration-200 flex items-center space-x-2">
                        <i class="fas fa-times"></i>
                        <span>Close</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- File Preview Content -->
    <div class="glass-card rounded-2xl">
        <div class="p-6">
            {% if file_category == 'image' %}
                <!-- Image Preview -->
                <div class="flex justify-center">
                    <img src="{{ preview_url }}" 
                         alt="{{ file.name }}" 
                         class="max-w-full max-h-96 rounded-2xl shadow-2xl"
                         onerror="this.style.display='none'; document.getElementById('fallbackMessage').style.display='block';">
                </div>
            
            {% elif file_category == 'pdf' %}
                <!-- PDF Preview -->
                <div class="w-full h-96">
                    <iframe src="{{ preview_url }}" 
                            class="w-full h-full rounded-2xl border-0"
                            onerror="document.getElementById('fallbackMessage').style.display='block';">
                    </iframe>
                </div>
            
            {% elif file_category == 'text' or file_category == 'code' %}
                <!-- Text/Code Preview -->
                <div class="w-full h-96 bg-gray-900 rounded-2xl overflow-hidden">
                    <iframe src="{{ preview_url }}" 
                            class="w-full h-full border-0"
                            onerror="document.getElementById('fallbackMessage').style.display='block';">
                    </iframe>
                </div>
            
            {% else %}
                <!-- Unsupported file type -->
                <div class="text-center py-16">
                    <div class="floating mb-6">
                        <i class="fas fa-file text-8xl text-gray-300"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-700 mb-4">Preview Not Available</h3>
                    <p class="text-gray-500 text-lg mb-8 max-w-md mx-auto">
                        This file type cannot be previewed directly in the browser.
                    </p>
                    <a href="{% url 'download_file' file.id %}" 
                       class="btn-gradient text-white px-8 py-4 rounded-xl font-semibold text-lg shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 inline-flex items-center space-x-3">
                        <i class="fas fa-download"></i>
                        <span>Download to View</span>
                    </a>
                </div>
            {% endif %}

            <!-- Fallback message for preview errors -->
            <div id="fallbackMessage" class="text-center py-8 hidden">
                <div class="bg-yellow-50 border border-yellow-200 rounded-2xl p-6">
                    <i class="fas fa-exclamation-triangle text-yellow-600 text-4xl mb-4"></i>
                    <h4 class="text-lg font-semibold text-yellow-800 mb-2">Preview Unavailable</h4>
                    <p class="text-yellow-700">
                        Unable to load preview. The file may be too large or the preview is not supported.
                    </p>
                    <a href="{% url 'download_file' file.id %}" 
                       class="mt-4 inline-flex items-center px-6 py-3 bg-yellow-600 text-white rounded-xl font-semibold hover:bg-yellow-700 transition-colors">
                        <i class="fas fa-download mr-2"></i>
                        Download File
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- File Info Card -->
    <div class="glass-card rounded-2xl mt-6">
        <div class="px-6 py-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">File Information</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div>
                    <p class="text-sm text-gray-600">File Name</p>
                    <p class="font-semibold text-gray-800 truncate">{{ file.name }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-600">File Type</p>
                    <p class="font-semibold text-gray-800">{{ file.file_type|upper }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-600">File Size</p>
                    <p class="font-semibold text-gray-800">{{ file.size|filesizeformat }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-600">Upload Date</p>
                    <p class="font-semibold text-gray-800">{{ file.uploaded_at|date:"M d, Y H:i" }}</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Auto-hide fallback message after 5 seconds if shown
    document.addEventListener('DOMContentLoaded', function() {
        const fallbackMessage = document.getElementById('fallbackMessage');
        if (fallbackMessage.style.display === 'block') {
            setTimeout(() => {
                fallbackMessage.style.display = 'none';
            }, 5000);
        }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            window.history.back();
        }
        if (e.key === 'd' && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            window.location.href = "{% url 'download_file' file.id %}";
        }
    });
</script>
{% endblock %}
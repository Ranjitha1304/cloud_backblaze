{% extends 'base.html' %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Page Header -->
    <div class="glass-card rounded-2xl mb-8 transform transition-all duration-300 hover:scale-[1.01]">
        <div class="px-6 py-8">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">Trash</h1>
                    <nav class="flex" aria-label="Breadcrumb">
                        <ol class="flex items-center space-x-3">
                            <li>
                                <a href="{% url 'file_list' %}" class="text-gray-500 hover:text-gray-700 transition-colors">
                                    <i class="fas fa-home"></i>
                                </a>
                            </li>
                            <li class="flex items-center">
                                <span class="text-gray-400 mx-2">/</span>
                                <span class="text-gray-700 font-medium">Trash</span>
                            </li>
                        </ol>
                    </nav>
                </div>
                <div class="flex space-x-4">
                    {% if files %}
                    <button onclick="restoreAllFiles()" 
                            class="bg-green-600 text-white px-6 py-3 rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 flex items-center space-x-2">
                        <i class="fas fa-undo"></i>
                        <span>Restore All</span>
                    </button>
                    <button onclick="emptyTrash()" 
                            class="bg-red-600 text-white px-6 py-3 rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 flex items-center space-x-2">
                        <i class="fas fa-trash"></i>
                        <span>Empty Trash</span>
                    </button>
                    {% endif %}
                    <a href="{% url 'file_list' %}" 
                       class="bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 flex items-center space-x-2">
                        <i class="fas fa-arrow-left"></i>
                        <span>Back to Files</span>
                    </a>
                </div>
            </div>

            <!-- Info Box -->
            <!-- <div class="bg-yellow-50 border border-yellow-200 rounded-2xl p-6">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-yellow-600 text-2xl mr-4"></i>
                    <div>
                        <h3 class="text-lg font-semibold text-yellow-800">Files in Trash</h3>
                        <p class="text-yellow-700 mt-1">
                            Files in trash will be automatically permanently deleted after 30 days.
                            You can restore them or delete them permanently.
                        </p>
                    </div>
                </div>
            </div> -->
        </div>
    </div>

    <!-- Files List -->
    <div class="glass-card rounded-2xl">
        <div class="px-6 py-6 border-b border-gray-200/50 flex justify-between items-center">
            <h2 class="text-xl font-bold text-gray-800 flex items-center space-x-3">
                <i class="fas fa-trash text-red-500"></i>
                <span>Deleted Files</span>
            </h2>
            <span class="text-sm font-medium text-gray-600 bg-white/50 rounded-full px-4 py-2">
                {{ files|length }} file{{ files|length|pluralize }} in trash
            </span>
        </div>
        
        <div class="px-6 py-6">
            {% if files %}
            <div class="overflow-x-auto rounded-2xl">
                <table class="min-w-full divide-y divide-gray-200/50">
                    <thead class="bg-white/80">
                        <tr>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                File
                            </th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                Type
                            </th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                Size
                            </th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                Deleted
                            </th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white/50 divide-y divide-gray-200/30" id="filesContainer">
                        {% for file in files %}
                        <tr class="file-item hover:bg-white/80 transition-all duration-300 group">
                            <td class="px-6 py-5 whitespace-nowrap">
                                <div class="flex items-center space-x-4">
                                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-gray-400 to-gray-600 flex items-center justify-center shadow-md">
                                        <i class="fas fa-file text-white text-sm"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center space-x-2 mb-1">
                                            <span class="file-name text-sm font-semibold text-gray-900 truncate max-w-xs">
                                                {{ file.name }}
                                            </span>
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800 shadow-sm">
                                                <i class="fas fa-trash mr-1 text-xs"></i>In Trash
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-5 whitespace-nowrap">
                                <span class="file-type text-sm font-medium text-gray-600 uppercase bg-gray-100 rounded-full px-3 py-1">
                                    {{ file.file_type|default:"Unknown" }}
                                </span>
                            </td>
                            <td class="px-6 py-5 whitespace-nowrap">
                                <span class="file-size text-sm font-semibold text-gray-700">{{ file.size|filesizeformat }}</span>
                            </td>
                            <td class="px-6 py-5 whitespace-nowrap">
                                {% with trash_item=file.trash_set.first %}
                                <span class="file-deleted text-sm text-gray-600">{{ trash_item.deleted_at|date:"M d, Y H:i" }}</span>
                                {% endwith %}
                            </td>
                            <td class="px-6 py-5 whitespace-nowrap">
                                <div class="flex space-x-2">
                                    <!-- Restore Button -->
                                    <button onclick="restoreFile('{{ file.id }}')" 
                                            class="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center text-green-600 hover:bg-green-200 transition-all duration-200 transform hover:scale-110 group"
                                            title="Restore File">
                                        <i class="fas fa-undo group-hover:animate-pulse"></i>
                                    </button>
                                    
                                    <!-- Permanent Delete Button -->
                                    <button onclick="permanentDeleteFile('{{ file.id }}')" 
                                            class="w-10 h-10 bg-red-100 rounded-xl flex items-center justify-center text-red-600 hover:bg-red-200 transition-all duration-200 transform hover:scale-110 group"
                                            title="Permanently Delete">
                                        <i class="fas fa-trash group-hover:animate-pulse"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <!-- Empty Trash State -->
            <div class="text-center py-16">
                <div class="floating mb-6">
                    <i class="fas fa-trash-alt text-8xl text-gray-300"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-700 mb-4">Trash is Empty</h3>
                <p class="text-gray-500 text-lg mb-8 max-w-md mx-auto">
                    Files you delete will appear here. They will be automatically permanently deleted after 30 days.
                </p>
                <a href="{% url 'file_list' %}" 
                   class="btn-gradient text-white px-8 py-4 rounded-xl font-semibold text-lg shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 inline-flex items-center space-x-3">
                    <i class="fas fa-arrow-left"></i>
                    <span>Back to Files</span>
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Confirmation Modals -->
<div id="emptyTrashModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 w-96">
        <div class="glass-card rounded-2xl shadow-2xl border border-white/20">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Empty Trash</h3>
                    <button onclick="hideEmptyTrashModal()" 
                            class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-600 hover:bg-gray-200 transition-colors">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="mb-6">
                    <div class="bg-red-50 border border-red-200 rounded-2xl p-4 mb-4">
                        <div class="flex items-center">
                            <i class="fas fa-exclamation-triangle text-red-600 text-xl mr-3"></i>
                            <div>
                                <p class="font-semibold text-red-800">Warning: Permanent Deletion</p>
                                <p class="text-red-700 text-sm mt-1">This action cannot be undone. All files in trash will be permanently deleted.</p>
                            </div>
                        </div>
                    </div>
                    <p class="text-gray-700">Are you sure you want to permanently delete all {{ files|length }} files in trash?</p>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button onclick="hideEmptyTrashModal()" 
                            class="px-6 py-3 bg-gray-500 text-white rounded-xl font-semibold hover:bg-gray-600 transition-all duration-200 transform hover:scale-105">
                        Cancel
                    </button>
                    <button onclick="confirmEmptyTrash()" 
                            class="px-6 py-3 bg-red-600 text-white rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105">
                        Yes, Empty Trash
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Restore file function
    function restoreFile(fileId) {
        const button = event.target.closest('button');
        const originalHtml = button.innerHTML;
        
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        button.disabled = true;
        
        fetch(`/file/restore/${fileId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                // Remove the file row with animation
                const fileRow = button.closest('.file-item');
                fileRow.style.opacity = '0';
                fileRow.style.transform = 'translateX(100px)';
                setTimeout(() => fileRow.remove(), 500);
            } else {
                throw new Error(data.error);
            }
        })
        .catch(error => {
            showNotification('Error: ' + error.message, 'error');
            button.innerHTML = originalHtml;
            button.disabled = false;
        });
    }

    // Restore all files
    function restoreAllFiles() {
        const button = event.target.closest('button');
        const originalHtml = button.innerHTML;
        
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Restoring...';
        button.disabled = true;
        
        fetch('/file/restore-all/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                throw new Error(data.error);
            }
        })
        .catch(error => {
            showNotification('Error: ' + error.message, 'error');
            button.innerHTML = originalHtml;
            button.disabled = false;
        });
    }

    // Permanent delete file
    function permanentDeleteFile(fileId) {
        if (confirm('Are you sure you want to permanently delete this file? This action cannot be undone.')) {
            const button = event.target.closest('button');
            const originalHtml = button.innerHTML;
            
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            button.disabled = true;
            
            fetch(`/file/permanent-delete/${fileId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    // Remove the file row with animation
                    const fileRow = button.closest('.file-item');
                    fileRow.style.opacity = '0';
                    fileRow.style.transform = 'translateX(100px)';
                    setTimeout(() => fileRow.remove(), 500);
                } else {
                    throw new Error(data.error);
                }
            })
            .catch(error => {
                showNotification('Error: ' + error.message, 'error');
                button.innerHTML = originalHtml;
                button.disabled = false;
            });
        }
    }

    // Empty trash modal functions
    function emptyTrash() {
        document.getElementById('emptyTrashModal').classList.remove('hidden');
    }

    function hideEmptyTrashModal() {
        document.getElementById('emptyTrashModal').classList.add('hidden');
    }

    function confirmEmptyTrash() {
        const button = document.querySelector('#emptyTrashModal button:last-child');
        const originalHtml = button.innerHTML;
        
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Deleting...';
        button.disabled = true;
        
        fetch('/file/empty-trash/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                hideEmptyTrashModal();
                setTimeout(() => location.reload(), 1000);
            } else {
                throw new Error(data.error);
            }
        })
        .catch(error => {
            showNotification('Error: ' + error.message, 'error');
            button.innerHTML = originalHtml;
            button.disabled = false;
        });
    }

    // Close modal when clicking outside
    document.addEventListener('click', function(event) {
        const modal = document.getElementById('emptyTrashModal');
        if (event.target === modal) {
            hideEmptyTrashModal();
        }
    });

    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            hideEmptyTrashModal();
        }
    });
</script>
{% endblock %}